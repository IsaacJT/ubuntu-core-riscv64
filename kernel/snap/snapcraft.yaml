name: sipeed-lichee-rv-kernel
version: 5.17.9
# TODO: evading user-defined plugin issues by choosing a different base
# This should not impact anything related to Ubuntu Core 22;
# the only "user-space" difference is the initrd, and snapd-bootstrap did not
# change between Core20 and Core22.
build-base: core20
summary: A RISC-V 64-bit kernel for Sipeed's Lichee RV board + dock
description: A RISC-V 64-bit kernel for Sipeed's Lichee RV board + dock
type: kernel

confinement: strict
grade: stable

architectures:
  - build-on: [amd64, riscv64]
    run-on:   [riscv64]

parts:
  kernel:
    plugin: x-kernel
    source: git://git.launchpad.net/~canonical-kernel/ubuntu/+source/linux-riscv/+git/jammy
    source-tag: allwinner-5.17-next
    source-depth: 1
    kernel-compiler: riscv64-linux-gnu-gcc
    kernel-with-firmware: false
    kernel-image-target: Image
    kernel-initrd-channel: stable
    kernel-initrd-compression: gz
    kernel-device-trees:
      - allwinner/sun20i-d1-lichee-rv-dock
    kconfigflavour: "allwinner"
    kconfigs:
      - CONFIG_DEFAULT_HOSTNAME="Deimos"
      - CONFIG_SYSTEM_TRUSTED_KEYS=""
      - CONFIG_SYSTEM_REVOCATION_KEYS=""
      - CONFIG_NLS_ISO8859_1=y
      - CONFIG_CFG80211=y
      - CONFIG_DEBUG_INFO=n
      - CONFIG_DEBUG_INFO_BTF=n
      - CONFIG_DRM_AMDGPU=n
      - CONFIG_DRM_NOUVEAU=n
      - CONFIG_DRM_RADEON=n
      - CONFIG_DRM_SUN4I=y
      - CONFIG_DRM_SUN8I_DW_HDMI=y
      - CONFIG_DRM_SUN8I_MIXER=y
    override-pull: |
      snapcraftctl pull
      # TODO: remove when issue is resolved
      # https://github.com/kubiko/snapcraft-kernel-plugin/issues/20
      touch debian.allwinner/config/config.common.ports
    override-build: |
      cp -f ${SNAPCRAFT_PROJECT_DIR}/initrd/uc-initrd_20-*_riscv64.snap \
          ${SNAPCRAFT_PART_BUILD}/uc-initrd_20-stable_riscv64.snap

      snapcraftctl build
    stage: 
      - -config*
      - -Image-*
      - -initrd.img-*
      - -modules
      - -System.map*

  wlan-driver:
    after: [kernel]
    plugin: make
    source: https://github.com/lwfinger/rtl8723ds.git
    source-depth: 1
    override-build: |
      KVER=$(ls ${SNAPCRAFT_PROJECT_DIR}/parts/kernel/install/modules/ | cut -f1 -d/)
      make CROSS_COMPILE=riscv64-linux-gnu- \
        KSRC="${SNAPCRAFT_PROJECT_DIR}/parts/kernel/build" \
        ARCH=riscv KVER=${KVER}
      cp ${SNAPCRAFT_PART_BUILD}/8723ds.ko ${SNAPCRAFT_PART_INSTALL}/
    stage:
      - -modules

  depmod:
    plugin: nil
    after: [kernel, wlan-driver]
    override-build: |
      KVER=$(ls ${SNAPCRAFT_PROJECT_DIR}/parts/kernel/install/modules/ | cut -f1 -d/)
      # Collect all kernel and separately built modules
      cp -rf ${SNAPCRAFT_PROJECT_DIR}/parts/kernel/install/modules \
        ${SNAPCRAFT_PART_INSTALL}/
      cp -rf ${SNAPCRAFT_PROJECT_DIR}/parts/wlan-driver/install/8723ds.ko \
        ${SNAPCRAFT_PART_INSTALL}/modules/${KVER}/
      ln -rsf ${SNAPCRAFT_PART_INSTALL} ${SNAPCRAFT_PART_INSTALL}/lib
      depmod -b ${SNAPCRAFT_PART_INSTALL} ${KVER}
    stage:
      - modules

  firmware:
    source: https://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git
    source-type: git
    source-branch: main
    source-depth: 1
    plugin: nil
    stage:
      - -firmware/amd
      - -firmware/amdgpu
      - -firmware/asihpi
      - -firmware/cavium
      - -firmware/cxgb3
      - -firmware/cxgb4
      - -firmware/dpaa2
      - -firmware/i915
      - -firmware/intel
      - -firmware/iwlwifi-*
      - -firmware/liquidio
      - -firmware/matrox
      - -firmware/mediatek
      - -firmware/mellanox
      - -firmware/mrvl
      - -firmware/moxa
      - -firmware/netronome
      - -firmware/nvidia
      - -firmware/qed
      - -firmware/radeon
      - -firmware/rockchip
      - -firmware/ath10k/QCA9377/hw1.0/firmware-5.bin
      - -firmware/ath3k-1.fw
      - -firmware/qca/htbtfw20.tlv
      - -firmware/qcom
      - -firmware/s5p*
      - -usr
      - -lib
    organize:
      'lib/firmware': firmware/

  wlan-firmware:
    plugin: dump
    source: https://github.com/armbian/firmware.git
    source-depth: 1
    organize:
      "*": firmware/
    stage:
      - firmware/rtl_bt/rtl8723ds_*.bin

build-packages:
  - bison
  - cpio
  - device-tree-compiler
  - dpkg-dev
  - flex
  - libelf-dev
  - libfdt-dev
  - libssl-dev
  - pkg-config
  - u-boot-tools
  - on amd64:
    - binutils-riscv64-linux-gnu
    - gcc-riscv64-linux-gnu
  - else:
    - gcc
